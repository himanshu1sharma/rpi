var gpio = require('pi-gpio');

var servoControllerPin = 7;

exports.blinkInterval = function(req, res){
	blink(servoControllerPin, req.params.interval);
	res.json(200, {message: 'success'});
}

exports.blink = function(req, callback){
	blink(servoControllerPin);
	//res.json(200, {message: 'success'});
	callback(null,{status :200,message: 'success'});
}

exports.turnOn = function(req, callback){
	console.log(req.body.pin);
	writeHigh(req.body.pin);
	callback(null,{status :200,message: 'success'});
	//response.json(200, {message: 'success'});
	//response.send(null,null);
}

exports.turnOff = function(req,callback) {
	writeLow(req.body.pin);
	//res.json(200, {message: 'success'});
	callback(null,{status :200,message: 'success'});
}

exports.readState = function(req, callback){
	/*read(req.body.pin, function(err, value){
		res.json(200, {state: value});
	});
*/
 	pin = req.body.pin;
 		gpio.read(pin,function(err, value) {
	        console.log('Pin state of'+ pin + value);
		    });	
 		callback(null,{status :200,message: 'success'});
}


exports.blinkPattern = function(req,callback) {

	pin1 = req.body.pin1;
	pin2 = req.body.pin2;
	pin3 = req.body.pin3;
	pin4 = req.body.pin4;

	blinkPattern(pin1,pin2,pin3,pin4);
	//res.json(200, {message: 'success'});
	callback(null,{status :200,message: 'success'});
}

function blinkPattern(pin1, pin2,pin3,pin4,interval,blinkTime){
	//set default value of interval
	//time between turning on and off
	if(interval == undefined) interval = 500;
	//set default time for blinkTime
	//number of times to blink the light on and off
	if(blinkTime == undefined) blinkTime = 5;

	//initialize the counting variable
	var i = 1;

	//timed loop to turn on and off the loop
	function myloop(){
		setTimeout(function(){
			//alternating between off and on
			if(i%2 == 0){
				writeHigh(pin1);
				writeLow(pin2);
				writeHigh(pin3);
				writeLow(pin4);
			} else {
				writeLow(pin1);
				writeHigh(pin2);
				writeLow(pin3);
				writeHigh(pin4);
			}
			i++;
			if(i <= blinkTime*2){
				//still blinking
				myloop();
			} else {
				writeLow(pin1);
				writeLow(pin2);
				writeLow(pin3);
				writeLow(pin4);
				//the light has blinked blinkTime times
				// we are done with pin
				//closePin(pin)
			}
		}, interval);
	}
	//first call of the loop
	myloop();
}




function blink(pin, interval, blinkTime){
	//set default value of interval
	//time between turning on and off
	if(interval == undefined) interval = 500;
	//set default time for blinkTime
	//number of times to blink the light on and off
	if(blinkTime == undefined) blinkTime = 5;

	//initialize the counting variable
	var i = 1;

	//timed loop to turn on and off the loop
	function myloop(){
		setTimeout(function(){
			//alternating between off and on
			if(i%2 == 0){
				writeHigh(pin);
			} else {
				writeLow(pin);
			}
			i++;
			if(i <= blinkTime*2){
				//still blinking
				myloop();
			} else {
				//the light has blinked blinkTime times
				// we are done with pin
				//closePin(pin)
			}
		}, interval);
	}
	//first call of the loop
	myloop();
}

function writeHigh(pin){
	console.log(pin + " high");
	gpio.open(pin, "output", function(err) {
	    gpio.write(pin, 1, function() {
	        gpio.close(pin);
	    });
	});
}

function writeLow(pin){
	console.log(pin + " low");
		gpio.open(pin, "output", function(err) {
	    gpio.write(pin, 0, function() {
	        gpio.close(pin);
	    });
	});
}

function closePin(pin){
	console.log('Turning pin off since we are done.');
	console.log(pin + " -");
		gpio.open(pin, "output", function(err) {
	    gpio.write(pin, 0, function() { 
	        gpio.close(pin);
	    });
	});
}
/*
function read(pin, function(){
	console.log('Reading the state of pin' + pin);
	//console.log(pin + " -");
		 gpio.read(pin,function(err, value) {
	        console.log('Pin state of'+ pin + value);
	    });
	}); */